<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel TÃ©cnico Â· AtivaÃ§Ã£o & Retirada</title>
    <!-- Fonte moderna e Ã­cones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
        }

        body {
            background: linear-gradient(145deg, #e9eff7 0%, #dbe4f0 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
        }

        /* Menu de abas */
        .menu-abas {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .aba-btn {
            min-width: 250px;
            padding: 1.2rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            letter-spacing: 0.5px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            color: #1d3b66;
            box-shadow: 0 8px 16px -6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .aba-btn i {
            font-size: 1.3rem;
            color: #2a5c9a;
        }

        .aba-btn.ativo {
            background: linear-gradient(135deg, #1f4e8c, #2a5c9a);
            color: white;
            box-shadow: 0 15px 25px -8px #1f4e8c;
            border: none;
        }

        .aba-btn.ativo i {
            color: white;
        }

        .aba-btn:hover:not(.ativo) {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 12px 20px -8px rgba(0, 0, 0, 0.15);
        }

        /* ConteÃºdo das abas */
        .aba-conteudo {
            display: none;
        }

        .aba-conteudo.ativo {
            display: block;
        }

        /* Cards principais */
        .card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 32px;
            box-shadow: 0 20px 40px -8px rgba(18, 35, 60, 0.25), 0 8px 16px -6px rgba(0, 20, 50, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
            padding: 2rem;
        }

        h4 {
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: #13294b;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 2px solid rgba(23, 62, 115, 0.15);
            padding-bottom: 0.75rem;
            margin-bottom: 2rem;
        }

        h4 i {
            color: #2a5c9a;
            font-size: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 18px;
            box-shadow: 0 6px 12px -6px rgba(0, 50, 100, 0.3);
        }

        h5 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #1d3b66;
            margin: 0 0 1rem 0;
            letter-spacing: -0.01em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h5 i {
            color: #3a6cb0;
            font-size: 1.3rem;
        }

        label {
            font-weight: 550;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #1f3a5f;
            display: block;
            margin-bottom: 0.3rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 0.85rem 1.2rem;
            font-size: 1rem;
            border-radius: 20px;
            border: 1.5px solid #dfe7f0;
            background: white;
            transition: 0.15s;
            outline: none;
            color: #102331;
            font-weight: 450;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            margin-bottom: 1rem;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: #2f6bb0;
            box-shadow: 0 4px 12px rgba(33, 92, 172, 0.25);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0 0.5rem 0;
            flex-wrap: wrap;
        }

        button {
            min-width: 160px;
            margin: 0;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 8px 16px -6px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #1f4e8c, #2a5c9a);
            color: white;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button i {
            font-size: 1.1rem;
            transition: transform 0.2s ease;
        }

        button:hover i {
            transform: scale(1.1);
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 25px -8px #0e3a6b;
        }

        button:active {
            transform: translateY(0px);
            box-shadow: 0 5px 12px -4px rgba(0, 0, 0, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #1f4e8c, #2a5c9a);
        }

        .btn-primary {
            background: linear-gradient(135deg, #2c405c, #364d6b);
        }

        .btn-danger {
            background: linear-gradient(135deg, #9e4244, #b14d4f);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #7a3335, #9e4244);
            box-shadow: 0 15px 25px -8px #7a3335;
        }

        .btn-add {
            background: linear-gradient(135deg, #2a5c9a, #3a6cb0);
            min-width: 120px;
            padding: 0.8rem 1.2rem;
            font-size: 0.9rem;
        }

        .btn-copy {
            background: linear-gradient(135deg, #364d6b, #4a6382);
            min-width: 160px;
            margin-left: auto;
        }

        .btn-load {
            background: linear-gradient(135deg, #4a6382, #5a7b9c);
            margin-right: 1rem;
        }

        hr {
            border: none;
            height: 2px;
            background: linear-gradient(90deg, #c0d4f0, #ffffff);
            margin: 2rem 0;
        }

        .equipe-bloco {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(4px);
            border-radius: 28px;
            padding: 1.8rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.8), 0 6px 12px -6px #94b3da;
        }

        .justificativas-container {
            margin-top: 1rem;
            margin-bottom: 1rem;
        }

        .justificativa-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 0.8rem;
            margin-bottom: 0.8rem;
            display: flex;
            gap: 0.8rem;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.9);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .justificativa-item input {
            margin-bottom: 0;
            flex: 1;
            padding: 0.7rem 1rem;
        }

        .btn-remove-just {
            background: linear-gradient(135deg, #9e4244, #b14d4f);
            min-width: 40px;
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-remove-just i {
            font-size: 1rem;
        }

        .btn-add-just {
            background: linear-gradient(135deg, #2a5c9a, #3a6cb0);
            width: 100%;
            margin-top: 0.5rem;
        }

        .relatorio-final {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 32px;
            padding: 2rem;
            box-shadow: 0 20px 40px -8px rgba(18, 35, 60, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.5);
            font-family: 'Inter', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
            color: #102331;
            margin-top: 2rem;
        }

        .relatorio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .row {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .col-md-3,
        .col-md-6 {
            flex: 1 1 200px;
        }

        .inline-icon {
            margin-right: 0.4rem;
            color: #3867a5;
        }

        /* Estilos especÃ­ficos da Retirada de Tempo */
        .total-box {
            background: linear-gradient(115deg, #e1edfc 0%, #d2e3fc 100%);
            border-radius: 28px;
            padding: 1.3rem 2rem;
            margin: 1.8rem 0 1.2rem 0;
            font-weight: 650;
            font-size: 1.3rem;
            color: #093057;
            border: 1px solid #b7d1f0;
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.8), 0 6px 12px -6px #94b3da;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            backdrop-filter: blur(4px);
        }

        .total-box i {
            font-size: 2rem;
            color: #236bb5;
        }

        .separador-linha {
            margin: 2rem 0;
            border-top: 2px dashed #a0b8d6;
            width: 100%;
        }

        #resultado-retirada {
            margin-top: 2rem;
            background: #f9fcff;
            padding: 1.8rem 2rem;
            border-radius: 28px;
            box-shadow: 0 10px 20px -10px rgba(0, 40, 80, 0.2);
            border: 1px solid #e0ecfe;
            font-family: 'Inter', monospace;
            line-height: 1.8;
            white-space: pre-line;
        }

        /* Grid para layout responsivo */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .card {
                padding: 1.5rem;
            }

            h4 {
                font-size: 1.6rem;
            }

            .btn-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .aba-btn {
                min-width: 200px;
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .btn-copy {
                margin-left: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Menu de abas -->
        <div class="menu-abas">
            <button class="aba-btn ativo" onclick="mudarAba('ativacao')">
                <i class="fas fa-clipboard-list"></i>
                RelatÃ³rio de AtivaÃ§Ã£o
            </button>
            <button class="aba-btn" onclick="mudarAba('retirada')">
                <i class="fas fa-hourglass-half"></i>
                Retirada de Tempo
            </button>
        </div>

        <!-- Aba 1: RelatÃ³rio de AtivaÃ§Ã£o -->
        <div id="aba-ativacao" class="aba-conteudo ativo">
            <div class="card mb-4">
                <h4>
                    <i class="fas fa-clipboard-list"></i>
                    InformaÃ§Ãµes do RelatÃ³rio
                </h4>

                <div class="row">
                    <div class="col-md-3">
                        <label><i class="far fa-calendar-alt inline-icon"></i>Data</label>
                        <input type="date" id="data-ativacao" value="">
                    </div>

                    <div class="col-md-3">
                        <label><i class="fas fa-map-marker-alt inline-icon"></i>Cidade - Estado</label>
                        <input type="text" id="cidade" placeholder="Picos - PI">
                    </div>

                    <div class="col-md-6">
                        <label><i class="fas fa-user-cog inline-icon"></i>Nome do TÃ©cnico Interno</label>
                        <input type="text" id="responsavel" placeholder="ResponsÃ¡vel">
                    </div>
                </div>

                <hr>

                <div id="equipes"></div>

                <div class="btn-group">
                    <button onclick="adicionarEquipe()" class="btn-success">
                        <i class="fas fa-plus-circle"></i>
                        Adicionar TÃ©cnico de Campo
                    </button>
                    <button onclick="carregarRelatorio()" class="btn-load">
                        <i class="fas fa-folder-open"></i>
                        Carregar RelatÃ³rio
                    </button>
                    <button onclick="emitirRelatorio()" class="btn-primary">
                        <i class="fas fa-check-double"></i>
                        Finalizar e Emitir RelatÃ³rio
                    </button>
                    <button onclick="apagarTodosRelatorios()" class="btn-danger">
                        <i class="fas fa-trash"></i>
                        Apagar Todos RelatÃ³rios
                    </button>
                    <button onclick="copiarRelatorio()" class="btn-copy" style="display: none;">
                        <i class="fas fa-copy"></i>
                        Copiar RelatÃ³rio
                    </button>
                </div>
            </div>

            <div id="resultado-ativacao" class="relatorio-final"></div>
        </div>

        <!-- Aba 2: Retirada de Tempo -->
        <div id="aba-retirada" class="aba-conteudo">
            <div class="card">
                <h4>
                    <i class="fas fa-hourglass-half"></i>
                    Retirada de Tempo
                </h4>

                <div class="grid-2">
                    <div>
                        <label><i class="far fa-calendar-alt inline-icon"></i>Data</label>
                        <input type="date" id="data-retirada" value="">
                    </div>
                    <div>
                        <label><i class="fas fa-user-cog inline-icon"></i>TÃ©cnico</label>
                        <input type="text" id="tecnico" placeholder="Digite o nome do tÃ©cnico">
                    </div>
                </div>

                <div class="total-box" id="tempoTotal">
                    <i class="fas fa-clock"></i>
                    <span>Tempo a Retirar: <strong>0 minutos</strong></span>
                </div>

                <div class="grid-2">
                    <div>
                        <label><i class="fas fa-play-circle inline-icon"></i>Hora Inicial</label>
                        <input type="time" id="inicio" value="">
                    </div>
                    <div>
                        <label><i class="fas fa-stop-circle inline-icon"></i>Hora Final</label>
                        <input type="time" id="fim" value="">
                    </div>
                </div>

                <label><i class="fas fa-pen inline-icon"></i>Motivo</label>
                <textarea id="motivo" placeholder="Descreva o motivo da retirada..."></textarea>

                <div class="btn-group">
                    <button onclick="adicionarRetirada()">
                        <i class="fas fa-plus-circle"></i>
                        <span>Adicionar perÃ­odo</span>
                    </button>
                    <button onclick="finalizarRetirada()">
                        <i class="fas fa-check-double"></i>
                        <span>Finalizar dia</span>
                    </button>
                    <button onclick="limparDataRetirada()" class="btn-danger">
                        <i class="fas fa-trash-alt"></i>
                        <span>Limpar esta data</span>
                    </button>
                </div>

                <hr>

                <div id="resultado-retirada"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== SISTEMA DE LIMPEZA AUTOMÃTICA (7 DIAS) ==========
        function limparDadosAntigos() {
            const diasParaExpirar = 7;
            const agora = new Date().getTime();
            const msPorDia = 24 * 60 * 60 * 1000;

            // Limpar registros de retirada
            let registros = JSON.parse(localStorage.getItem("registros")) || [];
            let registrosFiltrados = registros.filter(item => {
                if (!item.dataSalva) return true; // Itens antigos sem data

                const dataItem = new Date(item.dataSalva).getTime();
                const diferencaDias = (agora - dataItem) / msPorDia;
                return diferencaDias <= diasParaExpirar;
            });

            if (registros.length !== registrosFiltrados.length) {
                localStorage.setItem("registros", JSON.stringify(registrosFiltrados));
            }

            // Limpar relatÃ³rios salvos
            for (let i = 0; i < localStorage.length; i++) {
                const chave = localStorage.key(i);
                if (chave && chave.startsWith('relatorio_')) {
                    const item = JSON.parse(localStorage.getItem(chave));
                    if (item && item.dataSalva) {
                        const dataItem = new Date(item.dataSalva).getTime();
                        const diferencaDias = (agora - dataItem) / msPorDia;
                        if (diferencaDias > diasParaExpirar) {
                            localStorage.removeItem(chave);
                        }
                    }
                }
            }
        }

        // Executar limpeza ao carregar a pÃ¡gina
        limparDadosAntigos();

        // ========== CONTROLE DE ABAS ==========
        function mudarAba(aba) {
            // Atualizar botÃµes
            document.querySelectorAll('.aba-btn').forEach(btn => btn.classList.remove('ativo'));
            event.target.classList.add('ativo');

            // Atualizar conteÃºdos
            document.getElementById('aba-ativacao').classList.remove('ativo');
            document.getElementById('aba-retirada').classList.remove('ativo');
            document.getElementById('aba-' + aba).classList.add('ativo');
        }

        // ========== FUNÃ‡ÃƒO PARA COPIAR RELATÃ“RIO ==========
        function copiarRelatorio() {
            const resultadoDiv = document.getElementById("resultado-ativacao");

            // Pega apenas o texto do relatÃ³rio
            const relatorioTexto = resultadoDiv.innerText.trim();

            if (!relatorioTexto) {
                alert('Nenhum relatÃ³rio para copiar!');
                return;
            }

            // Usando a API Clipboard moderna
            navigator.clipboard.writeText(relatorioTexto).then(() => {
                // Feedback visual
                const btn = document.querySelector('.btn-copy');
                const textoOriginal = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                btn.style.background = 'linear-gradient(135deg, #28a745, #34ce57)';

                setTimeout(() => {
                    btn.innerHTML = textoOriginal;
                    btn.style.background = 'linear-gradient(135deg, #364d6b, #4a6382)';
                }, 2000);
            }).catch(err => {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement("textarea");
                textArea.value = relatorioTexto;
                document.body.appendChild(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                    const btn = document.querySelector('.btn-copy');
                    const textoOriginal = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                    btn.style.background = 'linear-gradient(135deg, #28a745, #34ce57)';

                    setTimeout(() => {
                        btn.innerHTML = textoOriginal;
                        btn.style.background = 'linear-gradient(135deg, #364d6b, #4a6382)';
                    }, 2000);
                } catch (err) {
                    alert('Erro ao copiar relatÃ³rio. Selecione manualmente e copie (Ctrl+C).');
                }

                document.body.removeChild(textArea);
            });
        }

        // ========== RELATÃ“RIO DE ATIVAÃ‡ÃƒO ==========
        function adicionarJustificativa(container) {
            const justificativaItem = document.createElement("div");
            justificativaItem.className = "justificativa-item";

            justificativaItem.innerHTML = `
                    <input type="text" class="justificativa-texto" placeholder="Digite a justificativa...">
                    <button class="btn-remove-just" onclick="removerJustificativa(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;

            container.appendChild(justificativaItem);
        }

        function removerJustificativa(botao) {
            botao.parentElement.remove();
        }

        function adicionarEquipe() {
            const container = document.getElementById("equipes");

            const bloco = document.createElement("div");
            bloco.className = "equipe-bloco";

            bloco.innerHTML = `
                    <h5>
                        <i class="fas fa-user-hard-hat"></i>
                        TÃ©cnico de Campo
                    </h5>

                    <label><i class="fas fa-user inline-icon"></i>Nome</label>
                    <input type="text" class="nomeTecnico" placeholder="Nome do TÃ©cnico">

                    <label><i class="fas fa-table inline-icon"></i>Tabela de Dados</label>
                    <textarea class="tabelaDados" rows="6" placeholder="Cole aqui a tabela do tÃ©cnico..."></textarea>

                    <label><i class="fas fa-pen inline-icon"></i>Justificativas</label>
                    <div class="justificativas-container"></div>
                    
                    <button class="btn-add-just" onclick="adicionarJustificativa(this.previousElementSibling)">
                        <i class="fas fa-plus-circle"></i> Adicionar Justificativa
                    </button>

                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn-danger" onclick="this.parentElement.parentElement.remove()">
                            <i class="fas fa-trash-alt"></i>
                            Remover TÃ©cnico
                        </button>
                    </div>
                `;

            container.appendChild(bloco);
        }

        function processarTabela(texto) {

            if (!texto || texto.trim() === "") return null;

            const linhas = texto.trim().split("\n");
            if (linhas.length <= 1) return null;

            const dividirColunas = (linha) => linha.trim().split(/\t|\s{2,}/);
            const cabecalho = dividirColunas(linhas[0]);

            const indexServico = cabecalho.findIndex(c =>
                c.toLowerCase().includes("serviÃ§o") ||
                c.toLowerCase().includes("servico")
            );

            const indexStatus = cabecalho.findIndex(c =>
                c.toLowerCase().includes("feito") ||
                c.toLowerCase().includes("status")
            );

            if (indexServico === -1 || indexStatus === -1) {
                console.log("CabeÃ§alho nÃ£o identificado:", cabecalho);
                return null;
            }

            function normalizar(texto) {
                return texto
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[â€“â€”]/g, "-")
                    .replace(/\s+/g, " ")
                    .toUpperCase()
                    .trim();
            }

            function calcularValorServico(servico) {

                const s = servico.toUpperCase().replace(/\s+/g, "");
                const d = servico.toUpperCase().replace(/\s+/g, "");

                if (d.includes("RECORRÃŠNCIA")) {
                    return 1;
                }
                // ðŸ”¥ CASO ESPECIAL: REC + DES.PORTA = 0.5
                if (s.includes("REC+") && s.includes("DES.PORTA")) {
                    return 0.5;
                }


                // ðŸ”¥ 0.25 â†’ desativaÃ§Ã£o
                if (
                    servico.includes("DES.") ||
                    servico.includes("DESAT") ||
                    servico.includes("RECOLHER")
                ) {
                    return 0.25;
                }

                // ðŸ”¥ 1.5 â†’ conjugado
                if (servico.includes("+")) {
                    return 1.5;
                }

                // ðŸ”¥ 0.5 â†’ TV / IPTV / SVA / BOX / RecorrÃªncia
                if (
                    servico.includes("IPTV") ||
                    servico.includes("TV") ||
                    servico.includes("SVA") ||
                    servico.includes("BOX")
                ) {
                    return 0.5;
                }

                // ðŸ”¥ padrÃ£o
                return 1;
            }

            let planejamento = 0;
            let execucao = 0;
            let totalExecutado = 0;
            let remarcacao = 0;
            let cancelamento = 0;
            let tratativasCS = 0;
            let infraestrutura = 0;
            let resolucaoN2 = 0;

            let mapa = {};

            for (let i = 1; i < linhas.length; i++) {

                if (!linhas[i].trim()) continue;

                const colunas = dividirColunas(linhas[i]);

                const servicoOriginal = colunas[indexServico]?.trim();
                const statusOriginal = colunas[indexStatus]?.trim();

                if (!servicoOriginal || !statusOriginal) continue;

                const servico = normalizar(servicoOriginal);
                const status = normalizar(statusOriginal);

                const valorPlanejado = calcularValorServico(servico);
                planejamento += valorPlanejado;

                if (status.includes("CANCEL")) {
                    cancelamento++;
                    continue;
                }

                if (status === "RV" || status === "RC") {
                    remarcacao++;
                    continue;
                }

                if (status.includes("OK") || status.includes("FEITO")) {

                    execucao++;

                    const valor = calcularValorServico(servico);
                    totalExecutado += valor;

                    if (!mapa[servicoOriginal]) mapa[servicoOriginal] = 0;
                    mapa[servicoOriginal] += 1;

                    if (servico.includes("TRATATIVA CS"))
                        tratativasCS++;

                    if (servico.includes("INFRAESTRUTURA"))
                        infraestrutura++;

                    if (servico.includes("NIVEL 2"))
                        resolucaoN2++;
                }
            }

            return {
                planejamento,
                execucao,
                totalExecutado,
                remarcacao,
                cancelamento,
                tratativasCS,
                infraestrutura,
                resolucaoN2,
                mapa
            };
        }

        // FunÃ§Ã£o para buscar retiradas de tempo por tÃ©cnico e data
        function buscarRetiradasPorTecnicoData(tecnico, data) {
            let registros = JSON.parse(localStorage.getItem("registros")) || [];

            // Filtrar registros que correspondem ao tÃ©cnico e data
            let retiradas = registros.filter(r =>
                r.tecnico.toLowerCase().trim() === tecnico.toLowerCase().trim() &&
                r.data === data
            );

            return retiradas;
        }

        // FunÃ§Ã£o auxiliar para formatar data
        function formatarDataISO(dataISO) {
            if (!dataISO) return "";
            let [ano, mes, dia] = dataISO.split("-");
            return `${dia}/${mes}/${ano}`;
        }

        // FunÃ§Ã£o para salvar relatÃ³rio no localStorage
        function salvarRelatorio(data, dados) {
            const chave = `relatorio_${data}`;
            const item = {
                data: data,
                dados: dados,
                dataSalva: new Date().toISOString()
            };
            localStorage.setItem(chave, JSON.stringify(item));
        }

        // FunÃ§Ã£o para carregar relatÃ³rio do localStorage
        function carregarRelatorio() {
            const data = document.getElementById("data-ativacao").value;
            if (!data) {
                alert('Selecione uma data primeiro!');
                return;
            }

            const chave = `relatorio_${data}`;
            const itemSalvo = localStorage.getItem(chave);

            if (!itemSalvo) {
                alert('Nenhum relatÃ³rio encontrado para esta data!');
                return;
            }

            try {
                const item = JSON.parse(itemSalvo);
                const dados = item.dados;

                // Limpar equipes existentes
                document.getElementById("equipes").innerHTML = '';

                // Preencher dados bÃ¡sicos
                document.getElementById("cidade").value = dados.cidade || '';
                document.getElementById("responsavel").value = dados.responsavel || '';

                // Recriar equipes
                if (dados.equipes && dados.equipes.length > 0) {
                    dados.equipes.forEach(equipe => {
                        adicionarEquipe();
                        const blocos = document.querySelectorAll(".equipe-bloco");
                        const bloco = blocos[blocos.length - 1];

                        // Preencher nome do tÃ©cnico
                        bloco.querySelector('.nomeTecnico').value = equipe.nome || '';

                        // Preencher tabela de dados
                        bloco.querySelector('.tabelaDados').value = equipe.tabela || '';

                        // Recriar justificativas
                        const container = bloco.querySelector('.justificativas-container');
                        if (equipe.justificativas && equipe.justificativas.length > 0) {
                            equipe.justificativas.forEach(just => {
                                adicionarJustificativa(container);
                                const inputs = container.querySelectorAll('.justificativa-texto');
                                inputs[inputs.length - 1].value = just;
                            });
                        }
                    });
                }

                alert('RelatÃ³rio carregado com sucesso!');
            } catch (e) {
                alert('Erro ao carregar relatÃ³rio!');
                console.error(e);
            }
        }

        // FunÃ§Ã£o principal para emitir relatÃ³rio
        function emitirRelatorio() {
            const data = document.getElementById("data-ativacao").value;
            const cidade = document.getElementById("cidade").value;
            const responsavel = document.getElementById("responsavel").value;

            const nomes = document.querySelectorAll(".nomeTecnico");
            const tabelas = document.querySelectorAll(".tabelaDados");
            const blocos = document.querySelectorAll(".equipe-bloco");

            let totalEquipes = 0;
            nomes.forEach(nome => {
                if (nome.value.trim() !== "") totalEquipes++;
            });

            let relatorio = "";

            // ðŸ”¥ TOTAIS GERAIS
            let totalPlanejamentoGeral = 0;
            let totalExecutadoGeral = 0;
            let totalRemarcacaoGeral = 0;
            let totalCancelamentoGeral = 0;

            relatorio += `RelatÃ³rio de AtivaÃ§Ã£o â€“ ${formatarData(data)} - ${cidade}\n`;
            relatorio += `ResponsÃ¡vel: ${responsavel}\n`;
            relatorio += `NÃºmero de Equipes: ${totalEquipes}\n\n`;

            const dadosParaSalvar = {
                cidade: cidade,
                responsavel: responsavel,
                equipes: []
            };

            for (let i = 0; i < nomes.length; i++) {

                const nome = nomes[i].value.trim();
                const dados = processarTabela(tabelas[i].value);

                if (!nome || !dados) continue;

                // ðŸ”¥ SOMA TODOS OS TOTAIS
                totalPlanejamentoGeral += dados.planejamento;
                totalExecutadoGeral += dados.totalExecutado;
                totalRemarcacaoGeral += dados.remarcacao;
                totalCancelamentoGeral += dados.cancelamento;

                relatorio += `-----------------------------------------------\n\n`;
                relatorio += `Equipe TÃ©cnica: ${nome}\n\n`;

                relatorio += `    â€¢ Planejamento: ${dados.planejamento}\n`;
                relatorio += `    â€¢ ExecuÃ§Ã£o: ${dados.execucao}\n`;
                relatorio += `    â€¢ RemarcaÃ§Ã£o: ${dados.remarcacao}\n`;
                relatorio += `    â€¢ Cancelamento: ${dados.cancelamento}\n`;
                relatorio += `    â€¢ Tratativas CS: ${dados.tratativasCS}\n`;
                relatorio += `    â€¢ Infraestrutura: ${dados.infraestrutura}\n`;
                relatorio += `    â€¢ ResoluÃ§Ã£o N2: ${dados.resolucaoN2}\n\n`;

                relatorio += `Resumo de Atividades:\n\n`;

                for (let tipo in dados.mapa) {
                    relatorio += `          â€¢ ${tipo}: ${dados.mapa[tipo]}\n`;
                }

                relatorio += `\n`;
                relatorio += `    â€¢ Total de ServiÃ§os Executados: ${dados.totalExecutado.toString().replace(".", ",")}\n\n`;

                // ===== JUSTIFICATIVAS =====
                relatorio += `Justificativa:\n`;

                let contadorJustificativas = 1;
                const justificativasContainer = blocos[i].querySelector(".justificativas-container");
                const justificativasManuais = [];

                if (justificativasContainer) {
                    const justificativasTextos = justificativasContainer.querySelectorAll(".justificativa-texto");
                    justificativasTextos.forEach(input => {
                        const texto = input.value.trim();
                        if (texto !== "") {
                            relatorio += `${contadorJustificativas}Âº ${texto}\n`;
                            justificativasManuais.push(texto);
                            contadorJustificativas++;
                        }
                    });
                }

                let retiradas = buscarRetiradasPorTecnicoData(nome, data);

                if (retiradas && retiradas.length > 0) {
                    retiradas.forEach(retirada => {
                        relatorio += `${contadorJustificativas}Âº ${retirada.motivo}\n`;
                        contadorJustificativas++;
                    });
                }

                relatorio += `\n`;

                dadosParaSalvar.equipes.push({
                    nome: nome,
                    tabela: tabelas[i].value,
                    justificativas: justificativasManuais
                });
            }

            // ðŸ”¥ BLOCO DE TOTAIS GERAIS
            let blocoTotais = "";
            blocoTotais += `Total de ServiÃ§os Planejados: ${totalPlanejamentoGeral}\n`;
            blocoTotais += `Total de ServiÃ§os Executados: ${totalExecutadoGeral.toString().replace(".", ",")}\n`;
            blocoTotais += `Total de ServiÃ§os Remarcados: ${totalRemarcacaoGeral}\n`;
            blocoTotais += `Total de ServiÃ§os Cancelados: ${totalCancelamentoGeral}\n\n`;

            // Inserir apÃ³s NÃºmero de Equipes
            relatorio = relatorio.replace(
                `NÃºmero de Equipes: ${totalEquipes}\n\n`,
                `NÃºmero de Equipes: ${totalEquipes}\n\n${blocoTotais}`
            );

            salvarRelatorio(data, dadosParaSalvar);

            document.querySelector('.btn-copy').style.display = 'inline-flex';
            document.getElementById("resultado-ativacao").innerHTML = relatorio;
        }

        function formatarData(dataISO) {
            if (!dataISO) return "";
            const partes = dataISO.split("-");
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        // ========== RETIRADA DE TEMPO ==========
        let registros = JSON.parse(localStorage.getItem("registros")) || [];

        function salvarLocal() {
            // Adicionar data de salvamento para cada registro
            registros = registros.map(r => ({
                ...r,
                dataSalva: r.dataSalva || new Date().toISOString()
            }));
            localStorage.setItem("registros", JSON.stringify(registros));
        }

        function calcularMinutos(inicio, fim) {
            let [h1, m1] = inicio.split(":").map(Number);
            let [h2, m2] = fim.split(":").map(Number);

            let minutosInicio = h1 * 60 + m1;
            let minutosFim = h2 * 60 + m2;

            if (minutosFim <= minutosInicio) {
                alert("Hora final deve ser maior que a inicial.");
                return null;
            }
            return minutosFim - minutosInicio;
        }

        function formatarTempo(minutos) {
            if (minutos === 0) return "0 minutos";

            let horas = Math.floor(minutos / 60);
            let mins = minutos % 60;
            let partes = [];

            if (horas === 1) partes.push("1 hora");
            else if (horas > 1) partes.push(horas + " horas");

            if (mins === 1) partes.push("1 minuto");
            else if (mins > 1) partes.push(mins + " minutos");

            return partes.join(" e ");
        }

        function atualizarTempoTotal() {
            let tecnico = document.getElementById("tecnico").value;
            let data = document.getElementById("data-retirada").value;

            let total = registros
                .filter(r => r.tecnico === tecnico && r.data === data)
                .reduce((acc, r) => acc + r.minutos, 0);

            document.getElementById("tempoTotal").innerHTML =
                `<i class="fas fa-clock"></i> <span>Tempo a Retirar: <strong>${formatarTempo(total)}</strong></span>`;
        }

        function adicionarRetirada() {
            let data = document.getElementById("data-retirada").value;
            let tecnico = document.getElementById("tecnico").value.trim();
            let inicio = document.getElementById("inicio").value;
            let fim = document.getElementById("fim").value;
            let motivo = document.getElementById("motivo").value.trim();

            if (!data || !tecnico || !inicio || !fim || !motivo) {
                alert("Preencha todos os campos!");
                return;
            }

            let minutos = calcularMinutos(inicio, fim);
            if (minutos === null) return;

            registros.push({
                data,
                tecnico,
                motivo,
                minutos,
                dataSalva: new Date().toISOString()
            });
            salvarLocal();

            atualizarTempoTotal();

            document.getElementById("inicio").value = "";
            document.getElementById("fim").value = "";
            document.getElementById("motivo").value = "";
        }

        function finalizarRetirada() {
            let dataSelecionada = document.getElementById("data-retirada").value;
            let resultadoDiv = document.getElementById("resultado-retirada");
            resultadoDiv.innerHTML = "";

            let registrosDaData = registros.filter(r => r.data === dataSelecionada);

            if (registrosDaData.length === 0) {
                resultadoDiv.innerHTML = "Nenhum registro nesta data.";
                return;
            }

            let tecnicos = [...new Set(registrosDaData.map(r => r.tecnico))];

            tecnicos.forEach((tecnico, index) => {
                let lista = registrosDaData.filter(r => r.tecnico === tecnico);
                let total = lista.reduce((acc, r) => acc + r.minutos, 0);

                let bloco = document.createElement("div");
                bloco.style.marginBottom = "2rem";

                bloco.innerHTML = `Retirada De Tempo<br><br>`;
                bloco.innerHTML += `Data: ${formatarDataISO(dataSelecionada)}<br>`;
                bloco.innerHTML += `TÃ©cnico: ${tecnico}<br>`;
                bloco.innerHTML += `Tempo a Retirar: ${formatarTempo(total)}<br><br>`;

                lista.forEach(r => {
                    bloco.innerHTML += `Tempo: ${formatarTempo(r.minutos)}.<br>`;
                    bloco.innerHTML += `Motivo: ${r.motivo}<br><br>`;
                });

                resultadoDiv.appendChild(bloco);

                if (index < tecnicos.length - 1) {
                    let separador = document.createElement("div");
                    separador.className = "separador-linha";
                    resultadoDiv.appendChild(separador);
                }
            });
        }

        function apagarTodosRelatorios() {

            if (!confirm("âš ï¸ Deseja realmente apagar TODOS os relatÃ³rios salvos no navegador?")) {
                return;
            }

            let removidos = 0;

            // Precisamos copiar as chaves primeiro
            const chaves = [];

            for (let i = 0; i < localStorage.length; i++) {
                const chave = localStorage.key(i);
                if (chave && chave.startsWith("relatorio_")) {
                    chaves.push(chave);
                }
            }

            // Agora remover
            chaves.forEach(chave => {
                localStorage.removeItem(chave);
                removidos++;
            });

            // Limpa tela
            document.getElementById("resultado-ativacao").innerHTML = "";
            document.getElementById("equipes").innerHTML = "";

            alert(`âœ… ${removidos} relatÃ³rio(s) apagado(s) com sucesso!`);
        }

        function limparDataRetirada() {
            let dataSelecionada = document.getElementById("data-retirada").value;

            if (!confirm("Deseja realmente excluir todos os registros desta data?")) {
                return;
            }

            registros = registros.filter(r => r.data !== dataSelecionada);
            salvarLocal();

            document.getElementById("resultado-retirada").innerHTML = "";
            atualizarTempoTotal();

            alert("Registros da data removidos com sucesso!");
        }

        // Event listeners para Retirada de Tempo
        document.getElementById("tecnico").addEventListener("input", atualizarTempoTotal);
        document.getElementById("data-retirada").addEventListener("change", atualizarTempoTotal);

        // InicializaÃ§Ã£o
        window.onload = function () {
            atualizarTempoTotal();
            // Preencher data atual nos campos de data
            const hoje = new Date().toISOString().split('T')[0];
            if (!document.getElementById("data-ativacao").value) {
                document.getElementById("data-ativacao").value = hoje;
            }
            if (!document.getElementById("data-retirada").value) {
                document.getElementById("data-retirada").value = hoje;
            }

            // Esconder botÃ£o de copiar inicialmente
            document.querySelector('.btn-copy').style.display = 'none';
        };
    </script>
</body>

</html>